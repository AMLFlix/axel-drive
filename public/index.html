<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Axel Drive - Dashboard</title>
    <!-- Google Fonts: Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* Custom CSS Variables - Dark Theme Only, with Colorful Accents */
        :root {
            --background-color: #1a1a2e;
            --app-background: #202a40;
            --text-color: #e0e0e0;
            --heading-color: #bb86fc;
            --primary-color: #03dac6;
            --secondary-color: #6a6a8c;
            --danger-color: #cf6679;
            --border-color: #3b3b5c;
            --input-bg: #283452;
            --input-border: #4a5a70;
            --shadow-color: rgba(0, 0, 0, 0.5);
            --list-item-hover-bg: #2f3c5f;
            --header-bg: #202a40;
            --button-text-color: #ffffff;
            --icon-color: #bb86fc;
            --focus-ring-color: rgba(187, 134, 252, 0.4);
            --btn-primary-gradient: linear-gradient(45deg, #03dac6, #00c4b4);
            --btn-primary-hover-gradient: linear-gradient(45deg, #00c4b4, #00a89b);
            --btn-danger-gradient: linear-gradient(45deg, #cf6679, #b0576a);
            --btn-danger-hover-gradient: linear-gradient(45deg, #b0576a, #9e4a5a);
            --message-success-bg: linear-gradient(90deg, #4CAF50, #8bc34a);
            --message-error-bg: linear-gradient(90deg, #f44336, #e57373);
        }

        /* General Body Styles */
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--background-color);
            color: var(--text-color);
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            overflow-x: hidden;
            padding-bottom: 80px; /* Space for bottom nav */
        }

        /* Main App Container */
        #app {
            width: 100%;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            box-sizing: border-box;
            flex-grow: 1;
            transition: opacity 0.4s ease;
        }
        
        #app.loading {
            opacity: 0.5;
            pointer-events: none;
        }

        /* Page/View Animation */
        .view {
            animation: fadeIn 0.5s forwards;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(15px); }
            to { opacity: 1; transform: translateY(0); }
        }

        h2 {
            color: var(--heading-color);
            text-align: center;
            margin-bottom: 35px;
            font-size: 2.2em;
            font-weight: 600;
            text-shadow: 0 0 5px rgba(187, 134, 252, 0.3);
        }
        
        /* Bottom Navigation Bar */
        .bottom-nav {
            position: fixed; bottom: 0; left: 0; width: 100%;
            background-color: var(--header-bg); display: flex;
            justify-content: space-around; padding: 10px 0;
            box-shadow: 0 -5px 20px var(--shadow-color);
            border-top: 1px solid var(--border-color); z-index: 1000;
        }
        .nav-item {
            background: none; border: none; color: var(--secondary-color);
            display: flex; flex-direction: column; align-items: center;
            cursor: pointer; transition: color 0.3s ease, transform 0.3s ease;
            font-size: 0.8em; padding: 5px 10px; border-radius: 8px;
        }
        .nav-item i { font-size: 1.6em; margin-bottom: 5px; }
        .nav-item.active { color: var(--primary-color); transform: scale(1.1); }
        .nav-item:hover:not(.active) { color: var(--text-color); }

        /* Generic Button */
        .btn {
            background: var(--btn-primary-gradient); padding: 14px 28px;
            border: none; border-radius: 12px; cursor: pointer;
            font-size: 1.05em; font-weight: 600; transition: all 0.3s ease;
            color: var(--button-text-color); display: inline-flex;
            align-items: center; justify-content: center; gap: 8px;
            text-shadow: 0 1px 2px rgba(0,0,0,0.2);
            box-shadow: 0 6px 20px var(--shadow-color);
        }
        .btn:hover { transform: translateY(-3px); box-shadow: 0 8px 25px var(--shadow-color); }
        .btn.btn-danger { background: var(--btn-danger-gradient); }
        .btn.btn-danger:hover { background: var(--btn-danger-hover-gradient); }
        
        /* Icon only Button */
        .btn-icon {
            background: var(--app-background); border: 1px solid var(--border-color);
            color: var(--text-color); width: 40px; height: 40px; border-radius: 50%;
            cursor: pointer; font-size: 1em; transition: all 0.2s ease;
            display: inline-flex; align-items: center; justify-content: center;
            box-shadow: 0 4px 10px var(--shadow-color);
        }
        .btn-icon:hover { transform: translateY(-2px); box-shadow: 0 6px 15px var(--shadow-color); }
        .btn-icon.view-btn:hover { color: #2196F3; border-color: #2196F3; }
        .btn-icon.edit-btn:hover { color: #FFC107; border-color: #FFC107; }
        .btn-icon.delete-btn:hover { color: var(--danger-color); border-color: var(--danger-color); }
        .btn-icon.play-btn:hover { color: var(--primary-color); border-color: var(--primary-color); }
        .btn-icon.copy-link-btn:hover { color: #9C27B0; border-color: #9C27B0; }
        .btn-icon.browse-folder-btn:hover { color: #00BCD4; border-color: #00BCD4; }

        /* Form Styling */
        .form-container { background-color: var(--app-background); padding: 30px; border-radius: 16px; }
        .form-group { margin-bottom: 25px; }
        .form-group label { display: block; margin-bottom: 10px; font-weight: 500; color: var(--text-color); }
        .form-group input {
            width: 100%; padding: 14px; box-sizing: border-box;
            border: 1px solid var(--input-border); border-radius: 10px; font-size: 1em;
            background-color: var(--input-bg); color: var(--text-color);
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
        }
        .form-group input:focus {
            border-color: var(--heading-color);
            box-shadow: 0 0 0 4px var(--focus-ring-color); outline: none;
        }

        /* List Item Styling (Accounts & Files) */
        .item-list { list-style: none; padding: 0; margin: 0; }
        .list-item {
            display: flex; align-items: center; padding: 20px;
            margin-bottom: 15px; background-color: var(--app-background);
            border-radius: 16px; box-shadow: 0 4px 15px var(--shadow-color);
            transition: all 0.3s ease; border: 1px solid var(--border-color);
        }
        .list-item:hover { transform: translateY(-5px) scale(1.02); box-shadow: 0 8px 25px var(--shadow-color); background-color: var(--list-item-hover-bg); }
        .list-item-info { flex-grow: 1; display: flex; align-items: center; gap: 15px; }
        .list-item-info i { font-size: 1.8em; color: var(--icon-color); width: 30px; text-align: center; }
        .list-item-name { font-size: 1.2em; font-weight: 500; }
        .list-item-details { font-size: 0.9em; color: var(--secondary-color); margin-top: 4px; }
        .list-item-actions { display: flex; gap: 12px; }

        /* Drive Browser Specifics */
        .browser-header { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px; margin-bottom: 20px; }
        .search-container { display: flex; flex-grow: 1; gap: 10px; }
        .search-container input { flex-grow: 1; padding: 12px; }
        #pagination { text-align: center; margin-top: 25px; }
        #mediaPlayerContainer { margin-top: 30px; background-color: var(--app-background); padding: 20px; border-radius: 16px; }
        #mediaPlayerContainer video, #mediaPlayerContainer audio { width: 100%; border-radius: 12px; }
        
        /* Modal, Message Styling */
        #messageContainer { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); z-index: 10001; width: 90%; max-width: 500px; }
        .message { padding: 15px 25px; border-radius: 10px; margin-bottom: 10px; font-weight: 500; text-align: center; color: white; box-shadow: 0 5px 20px var(--shadow-color); animation: slideDownFadeOut 5s forwards; }
        .message.success { background: var(--message-success-bg); }
        .message.error { background: var(--message-error-bg); }
        @keyframes slideDownFadeOut { 0% { opacity: 0; transform: translateY(-20px); } 10%, 90% { opacity: 1; transform: translateY(0); } 100% { opacity: 0; transform: translateY(-20px); } }

        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.85); display: none; justify-content: center; align-items: center; z-index: 10000; backdrop-filter: blur(5px); }
        .modal-content { background-color: var(--app-background); padding: 40px; border-radius: 20px; text-align: center; max-width: 500px; width: 90%; color: var(--text-color); border: 1px solid var(--border-color); animation: zoomIn 0.3s; }
        @keyframes zoomIn { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        .modal-content p { font-size: 1.2em; margin-bottom: 35px; }
        .modal-actions .btn { margin: 0 12px; }

        /* Responsive */
        @media (max-width: 768px) {
            h2 { font-size: 1.8em; }
            .list-item { flex-direction: column; align-items: flex-start; gap: 15px; }
            .list-item-actions { width: 100%; justify-content: flex-end; }
            .browser-header { flex-direction: column; }
        }
    </style>
</head>
<body>

    <div id="app">
        <!-- Content will be rendered here by JS -->
    </div>

    <nav class="bottom-nav">
        <!-- JS will control visibility of these items -->
    </nav>
    
    <div id="modal" class="modal-overlay">
        <div class="modal-content">
            <p id="modalMessage">Are you sure?</p>
            <div class="modal-actions">
                <button id="modalConfirm" class="btn">Confirm</button>
                <button id="modalCancel" class="btn btn-danger">Cancel</button>
            </div>
        </div>
    </div>
    
    <div id="messageContainer"></div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const WORKER_BASE_URL = "https://axel-drive.comtv.workers.dev";
        const app = document.getElementById('app');
        const nav = document.querySelector('.bottom-nav');
        const modal = document.getElementById('modal');
        const modalMessage = document.getElementById('modalMessage');
        const modalConfirm = document.getElementById('modalConfirm');
        const modalCancel = document.getElementById('modalCancel');
        const messageContainer = document.getElementById('messageContainer');

        let adminToken = localStorage.getItem('admin_token');
        let onConfirmCallback = null;
        const CONSTS = {
            folder_mime_type: "application/vnd.google-apps.folder",
        };

        // --- Helper Functions ---
        async function apiRequest(endpoint, method = 'GET', body = null) {
            app.classList.add('loading');
            const headers = { 'Content-Type': 'application/json' };
            if (adminToken) {
                headers['Authorization'] = `Bearer ${adminToken}`;
            }

            try {
                const response = await fetch(`${WORKER_BASE_URL}${endpoint}`, { method, headers, body: body ? JSON.stringify(body) : null });
                if (response.status === 401) { // Unauthorized
                    logout();
                    throw new Error('Authentication failed. Please login again.');
                }
                const data = await response.json();
                if (!response.ok) {
                    throw new Error(data.error || 'API request failed');
                }
                return data;
            } catch (error) {
                showMessage(error.message, 'error');
                throw error;
            } finally {
                 app.classList.remove('loading');
            }
        }
        
        function showMessage(message, type = 'success') {
            const messageEl = document.createElement('div');
            messageEl.className = `message ${type}`;
            messageEl.textContent = message;
            messageContainer.appendChild(messageEl);
            setTimeout(() => messageEl.remove(), 4900);
        }

        function showConfirmModal(message, callback) {
            modalMessage.textContent = message;
            onConfirmCallback = callback;
            modal.style.display = 'flex';
        }

        modalConfirm.addEventListener('click', () => {
            if (onConfirmCallback) onConfirmCallback();
            modal.style.display = 'none';
        });
        modalCancel.addEventListener('click', () => {
            modal.style.display = 'none';
        });

        function logout() {
            localStorage.removeItem('admin_token');
            adminToken = null;
            renderUI();
        }

        // --- UI Rendering Functions ---
        function renderNav() {
            if (adminToken) {
                nav.innerHTML = `
                    <button class="nav-item active" data-view="accounts"><i class="fas fa-server"></i><span>Accounts</span></button>
                    <button class="nav-item" data-view="addAccount"><i class="fas fa-plus-circle"></i><span>Add New</span></button>
                    <button class="nav-item" data-view="settings"><i class="fas fa-cog"></i><span>Settings</span></button>
                `;
                 nav.style.display = 'flex';
            } else {
                nav.innerHTML = '';
                 nav.style.display = 'none';
            }
        }

        function renderView(view, params = {}) {
            renderNav();
            // Update nav active state
            nav.querySelectorAll('.nav-item').forEach(item => {
                item.classList.toggle('active', item.dataset.view === view);
            });
            
            // Clear previous content
            app.innerHTML = '';
            
            switch (view) {
                case 'login': renderLoginPage(); break;
                case 'accounts': renderAccountsPage(); break;
                case 'addAccount': renderAddEditAccountPage(); break;
                case 'editAccount': renderAddEditAccountPage(params.accountId); break;
                case 'browseDrive': renderDriveBrowserPage(params.accountId, params.folderId, params.searchTerm, params.pageToken); break;
                case 'settings': renderSettingsPage(); break;
                default: renderLoginPage();
            }
        }

        function renderLoginPage() {
            app.innerHTML = `
                <div class="view form-container">
                    <h2>Admin Login</h2>
                    <div class="form-group"><label for="username">Username</label><input type="text" id="username" value="admin"></div>
                    <div class="form-group"><label for="password">Password</label><input type="password" id="password" value="123admin"></div>
                    <button id="loginBtn" class="btn">Login</button>
                </div>`;
            document.getElementById('loginBtn').onclick = async () => {
                const username = document.getElementById('username').value;
                const password = document.getElementById('password').value;
                try {
                    const data = await apiRequest('/api/auth/login', 'POST', { username, password });
                    adminToken = data.token;
                    localStorage.setItem('admin_token', adminToken);
                    showMessage('Login successful!');
                    renderView('accounts');
                } catch (error) { /* showMessage is called in apiRequest */ }
            };
        }

        async function renderAccountsPage() {
            app.innerHTML = `<div class="view"><h2>Google Drive Accounts</h2><ul class="item-list" id="accountsList"><li>Loading...</li></ul></div>`;
            const listEl = document.getElementById('accountsList');
            try {
                const accounts = await apiRequest('/api/settings/list');
                listEl.innerHTML = accounts.length === 0 ? '<li>No accounts found. Add one from the "Add New" tab.</li>' :
                    accounts.map(acc => `
                        <li class="list-item">
                            <div class="list-item-info">
                                <i class="fab fa-google-drive"></i>
                                <div><div class="list-item-name">${acc.name}</div><div class="list-item-details">ID: ${acc.id}</div></div>
                            </div>
                            <div class="list-item-actions">
                                <button class="btn-icon view-btn" title="View Files" data-id="${acc.id}"><i class="fas fa-folder-open"></i></button>
                                <button class="btn-icon edit-btn" title="Edit" data-id="${acc.id}"><i class="fas fa-pencil-alt"></i></button>
                                <button class="btn-icon delete-btn" title="Delete" data-id="${acc.id}"><i class="fas fa-trash"></i></button>
                            </div>
                        </li>`).join('');
            } catch (error) {
                listEl.innerHTML = '<li>Failed to load accounts.</li>';
            }
        }

        async function renderAddEditAccountPage(accountId = null) {
            let account = {};
            if (accountId) {
                try {
                    account = await apiRequest(`/api/settings/get/${accountId}`);
                } catch (error) {
                    renderView('accounts');
                    return;
                }
            }
            app.innerHTML = `
                <div class="view form-container">
                    <h2>${accountId ? 'Edit' : 'Add'} Account</h2>
                    <div class="form-group"><label>Account ID</label><input type="text" id="accountId" value="${account.id || ''}" ${accountId ? 'readonly' : ''}></div>
                    <div class="form-group"><label>Account Name</label><input type="text" id="accountName" value="${account.name || ''}"></div>
                    <div class="form-group"><label>Client ID</label><input type="text" id="clientId" value="${account.client_id || ''}"></div>
                    <div class="form-group"><label>Client Secret</label><input type="text" id="clientSecret" value="${account.client_secret || ''}"></div>
                    <div class="form-group"><label>Refresh Token</label><input type="text" id="refreshToken" value="${account.refresh_token || ''}"></div>
                    <button id="saveAccountBtn" class="btn">Save Account</button>
                </div>`;
            document.getElementById('saveAccountBtn').onclick = async () => {
                const id = document.getElementById('accountId').value;
                const data = {
                    id: id, name: document.getElementById('accountName').value,
                    client_id: document.getElementById('clientId').value,
                    client_secret: document.getElementById('clientSecret').value,
                    refresh_token: document.getElementById('refreshToken').value
                };
                try {
                    if (accountId) await apiRequest(`/api/settings/update/${id}`, 'PUT', data);
                    else await apiRequest('/api/settings/add', 'POST', data);
                    showMessage(`Account ${accountId ? 'updated' : 'added'} successfully!`);
                    renderView('accounts');
                } catch (error) { /* Handled in apiRequest */ }
            };
        }
        
        async function renderDriveBrowserPage(accountId, folderId = null, searchTerm = null, pageToken = null) {
            const path = sessionStorage.getItem(`path_${accountId}`) ? JSON.parse(sessionStorage.getItem(`path_${accountId}`)) : [{id: null, name: 'Root'}];

            app.innerHTML = `
                <div class="view">
                    <div class="browser-header">
                        <div id="breadcrumbs"></div>
                        <div class="search-container">
                             <input type="text" id="searchDriveInput" class="form-group input" placeholder="Search in this account..." value="${searchTerm || ''}">
                             <button id="searchDriveBtn" class="btn"><i class="fas fa-search"></i></button>
                        </div>
                    </div>
                    <ul class="item-list" id="driveContent"><li>Loading...</li></ul>
                    <div id="pagination"></div>
                    <div id="mediaPlayerContainer"></div>
                </div>`;

            const driveContent = document.getElementById('driveContent');

            // Breadcrumbs
            const breadcrumbs = document.getElementById('breadcrumbs');
            if (!searchTerm) {
                breadcrumbs.innerHTML = path.map((p, i) => `<a href="#" class="breadcrumb-link" data-index="${i}">${p.name}</a>`).join(' &raquo; ');
            } else {
                 breadcrumbs.innerHTML = `<span>Search Results for "${searchTerm}"</span>`;
            }

            try {
                let apiUrl, queryParams = new URLSearchParams({ pageSize: 50 });
                if (searchTerm) {
                    apiUrl = `/api/drive/search/${accountId}`;
                    queryParams.append('q', searchTerm);
                } else {
                    apiUrl = `/api/drive/list/${accountId}/${folderId || ''}`;
                }
                if (pageToken) queryParams.append('pageToken', pageToken);
                
                const data = await apiRequest(`${apiUrl}?${queryParams.toString()}`);
                
                const getFileIcon = (mimeType) => {
                    if (mimeType === CONSTS.folder_mime_type) return 'fa-folder';
                    if (mimeType.startsWith('video/')) return 'fa-file-video';
                    if (mimeType.startsWith('audio/')) return 'fa-file-audio';
                    if (mimeType.startsWith('image/')) return 'fa-file-image';
                    return 'fa-file-alt';
                };

                driveContent.innerHTML = data.files && data.files.length > 0 ?
                    data.files.map(item => `
                        <li class="list-item">
                            <div class="list-item-info">
                                <i class="fas ${getFileIcon(item.mimeType)}"></i>
                                <div><div class="list-item-name">${item.name}</div></div>
                            </div>
                            <div class="list-item-actions">
                                ${item.mimeType !== CONSTS.folder_mime_type ? `<button class="btn-icon copy-link-btn" title="Copy Link" data-file-id="${item.id}"><i class="fas fa-link"></i></button>` : ''}
                                ${(item.mimeType.startsWith('video/') || item.mimeType.startsWith('audio/')) ? `<button class="btn-icon play-btn" title="Play" data-file-id="${item.id}" data-mime-type="${item.mimeType}"><i class="fas fa-play"></i></button>` : ''}
                                ${item.mimeType === CONSTS.folder_mime_type ? `<button class="btn-icon browse-folder-btn" title="Browse" data-folder-id="${item.id}" data-folder-name="${item.name}"><i class="fas fa-folder-open"></i></button>` : ''}
                            </div>
                        </li>`).join('') :
                    `<li>${searchTerm ? 'No search results found.' : 'This folder is empty.'}</li>`;
                
                // Pagination
                const paginationDiv = document.getElementById('pagination');
                paginationDiv.innerHTML = '';
                if (data.nextPageToken) {
                    const loadMoreBtn = document.createElement('button');
                    loadMoreBtn.className = 'btn';
                    loadMoreBtn.textContent = 'Load More';
                    loadMoreBtn.onclick = () => renderDriveBrowserPage(accountId, folderId, searchTerm, data.nextPageToken);
                    paginationDiv.appendChild(loadMoreBtn);
                }
            } catch (error) {
                driveContent.innerHTML = '<li>Error loading content.</li>';
            }
        }
        
        function renderSettingsPage(){
             app.innerHTML = `
                <div class="view form-container">
                    <h2>Settings</h2>
                    <p>You are logged in as an administrator.</p>
                    <button id="logoutBtn" class="btn btn-danger"><i class="fas fa-sign-out-alt"></i> Logout</button>
                </div>
             `;
        }

        // --- Event Delegation ---
        document.body.addEventListener('click', async (e) => {
            // Nav clicks
            const navLink = e.target.closest('.nav-item');
            if (navLink) return renderView(navLink.dataset.view);

            // Accounts page clicks
            if(e.target.closest('.view-btn')) {
                sessionStorage.removeItem(`path_${e.target.closest('.view-btn').dataset.id}`); // Clear path history
                return renderView('browseDrive', { accountId: e.target.closest('.view-btn').dataset.id });
            }
            if(e.target.closest('.edit-btn')) return renderView('editAccount', { accountId: e.target.closest('.edit-btn').dataset.id });
            if(e.target.closest('.delete-btn')) {
                const id = e.target.closest('.delete-btn').dataset.id;
                showConfirmModal(`Are you sure you want to delete account "${id}"?`, async () => {
                    try {
                        await apiRequest(`/api/settings/delete/${id}`, 'DELETE');
                        showMessage('Account deleted!');
                        renderView('accounts');
                    } catch (error) { /* Handled */ }
                });
            }

            // Drive browser clicks
            if(e.target.closest('.breadcrumb-link')) {
                e.preventDefault();
                const accountId = new URLSearchParams(window.location.search).get('accountId');
                const path = JSON.parse(sessionStorage.getItem(`path_${accountId}`) || '[]');
                const index = parseInt(e.target.dataset.index, 10);
                path.splice(index + 1); // Cut path to the clicked point
                sessionStorage.setItem(`path_${accountId}`, JSON.stringify(path));
                const folderId = path[path.length - 1].id;
                renderView('browseDrive', { accountId, folderId });
            }
             if(e.target.closest('.browse-folder-btn')) {
                const btn = e.target.closest('.browse-folder-btn');
                const accountId = new URLSearchParams(window.location.search).get('accountId');
                const path = JSON.parse(sessionStorage.getItem(`path_${accountId}`) || '[]');
                path.push({id: btn.dataset.folderId, name: btn.dataset.folderName});
                sessionStorage.setItem(`path_${accountId}`, JSON.stringify(path));
                renderView('browseDrive', { accountId, folderId: btn.dataset.folderId });
             }
             if(e.target.closest('.copy-link-btn')) {
                const accountId = new URLSearchParams(window.location.search).get('accountId');
                const fileId = e.target.closest('.copy-link-btn').dataset.fileId;
                const link = `${WORKER_BASE_URL}/api/drive/download/${accountId}/${fileId}`;
                navigator.clipboard.writeText(link).then(() => showMessage('Link copied!'), () => showMessage('Failed to copy.','error'));
             }
             if(e.target.closest('.play-btn')) {
                 const btn = e.target.closest('.play-btn');
                 const accountId = new URLSearchParams(window.location.search).get('accountId');
                 const fileId = btn.dataset.fileId;
                 const mimeType = btn.dataset.mimeType;
                 const streamUrl = `${WORKER_BASE_URL}/api/drive/download/${accountId}/${fileId}`;
                 const playerContainer = document.getElementById('mediaPlayerContainer');
                 
                 const playerHTML = mimeType.startsWith('video/') ? 
                    `<video controls autoplay><source src="${streamUrl}" type="${mimeType}"></video>` :
                    `<audio controls autoplay><source src="${streamUrl}" type="${mimeType}"></audio>`;
                 playerContainer.innerHTML = `<h3>Now Playing</h3>${playerHTML}`;
             }
             if(e.target.closest('#searchDriveBtn')) {
                const accountId = new URLSearchParams(window.location.search).get('accountId');
                const query = document.getElementById('searchDriveInput').value;
                if (query) renderView('browseDrive', { accountId, searchTerm: query });
             }
            
            // Settings clicks
            if(e.target.closest('#logoutBtn')) {
                 showConfirmModal('Are you sure you want to logout?', logout);
            }
        });

        // --- Initial Load ---
        function renderUI() {
            const params = new URLSearchParams(window.location.search);
            const view = params.get('view') || (adminToken ? 'accounts' : 'login');
            renderView(view, Object.fromEntries(params.entries()));
        }

        // Handle history changes (back/forward buttons)
        window.addEventListener('popstate', renderUI);

        // Initial render logic
        renderUI();
        // Update URL to reflect current view for better history/bookmarking
        history.replaceState({view: 'initial'}, '', `?view=${adminToken ? 'accounts' : 'login'}`);
        // Modify event listeners to push state
        document.body.addEventListener('click', e => {
            const navLink = e.target.closest('.nav-item');
            if (navLink) {
                history.pushState({view: navLink.dataset.view}, '', `?view=${navLink.dataset.view}`);
            }
            if(e.target.closest('.view-btn')) {
                const accountId = e.target.closest('.view-btn').dataset.id;
                history.pushState({view: 'browseDrive'}, '', `?view=browseDrive&accountId=${accountId}`);
            }
        });

    });
    </script>
</body>
</html>
