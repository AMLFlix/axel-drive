<!DOCTYPE html>
<html lang="my">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Axel Drive</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap">
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        :root {
            --bg-color: #1f1f1f;
            --surface-color: #282a2d;
            --text-primary: #e8eaed;
            --text-secondary: #bdc1c6;
            --border-color: #3c4043;
            --active-item-bg: #8ab4f8;
            --active-item-text: #202124;
            --btn-primary-bg: #8ab4f8;
            --btn-primary-text: #202124;
        }
        body { font-family: 'Roboto', sans-serif; background-color: var(--bg-color); color: var(--text-primary); margin: 0; display: flex; height: 100vh; overflow: hidden; }
        .sidebar { width: 256px; background-color: var(--surface-color); padding: 12px; display: flex; flex-direction: column; border-right: 1px solid var(--border-color); }
        .main-content { flex-grow: 1; display: flex; flex-direction: column; }
        .header { padding: 8px 24px; display: flex; align-items: center; border-bottom: 1px solid var(--border-color); }
        .app-container { flex-grow: 1; padding: 24px; overflow-y: auto; }
        /* Add other required styles here */
    </style>
</head>
<body>
    <aside class="sidebar">
        </aside>
    <div class="main-content">
        <header class="header">
            </header>
        <main id="app" class="app-container">
            </main>
    </div>

    <script>
        // --- CONFIG & STATE ---
        const WORKER_BASE_URL = ""; // Use relative path for same-domain setup
        const appDiv = document.getElementById('app');
        let adminToken = localStorage.getItem('admin_token');
        
        // --- HELPER FUNCTIONS ---
        async function apiRequest(endpoint, method = 'GET', body = null) {
            const headers = { 'Content-Type': 'application/json' };
            if (adminToken) {
                headers['Authorization'] = `Bearer ${adminToken}`;
            }
            try {
                const res = await fetch(`${WORKER_BASE_URL}${endpoint}`, { method, headers, body: body ? JSON.stringify(body) : null });
                if (!res.ok) {
                    const errorData = await res.json();
                    throw new Error(errorData.error || 'API request failed');
                }
                return res.status === 204 ? null : res.json();
            } catch (err) {
                console.error('API Error:', err);
                alert(`Error: ${err.message}`); // Simple alert for now
                throw err;
            }
        }
        
        // --- UI RENDERING ---
        function showLoginPage() {
            appDiv.innerHTML = `<div>... Login Form HTML ...</div>`;
            // Add login button logic
        }

        function showAddEditAccountPage() {
            appDiv.innerHTML = `
                <h2>Add New Google Drive Account</h2>
                <div class="card">
                    <div class="form-group">
                        <label>Account ID (Unique Identifier):</label>
                        <input type="text" id="accountId" placeholder="e.g., my-personal-drive">
                    </div>
                    <div class="form-group">
                        <label>Account Name:</label>
                        <input type="text" id="accountName" placeholder="e.g., Personal Drive">
                    </div>
                    <div style="text-align:center; padding: 20px 0;">
                        <button id="googleLoginBtn" class="btn btn-primary">Sign in with Google</button>
                    </div>
                    <div class="form-group">
                        <label>Refresh Token (Auto-filled):</label>
                        <input type="text" id="refreshToken" readonly>
                    </div>
                    <button id="saveAccountBtn" class="btn btn-success">Save Account</button>
                </div>
            `;
            
            document.getElementById('googleLoginBtn').onclick = () => {
                // ** IMPORTANT: REPLACE WITH YOUR ACTUAL CLIENT ID **
                const clientId = 'YOUR_GOOGLE_CLIENT_ID.apps.googleusercontent.com';
                const redirectUri = `${window.location.origin}/api/auth/callback`;
                const scope = 'https://www.googleapis.com/auth/drive';
                const authUrl = `https://accounts.google.com/o/oauth2/v2/auth?client_id=${clientId}&redirect_uri=${redirectUri}&response_type=code&scope=${scope}&access_type=offline&prompt=consent`;
                window.open(authUrl, 'googleLoginPopup', 'width=600,height=700');
            };

            document.getElementById('saveAccountBtn').onclick = async () => {
                const payload = {
                    id: document.getElementById('accountId').value,
                    name: document.getElementById('accountName').value,
                    refresh_token: document.getElementById('refreshToken').value,
                };
                if (!payload.id || !payload.name || !payload.refresh_token) {
                    return alert('All fields must be filled and token must be acquired.');
                }
                await apiRequest('/api/settings/add', 'POST', payload);
                alert('Account added successfully!');
                // navigateToAccountsPage();
            };
        }

        // --- EVENT LISTENERS & INITIALIZATION ---
        window.addEventListener('message', (event) => {
            if (event.origin !== window.location.origin) return;
            const { refreshToken, userEmail } = event.data;
            if (refreshToken) {
                const rtInput = document.getElementById('refreshToken');
                if (rtInput) rtInput.value = refreshToken;

                const nameInput = document.getElementById('accountName');
                if (nameInput && !nameInput.value) nameInput.value = userEmail;

                const idInput = document.getElementById('accountId');
                if (idInput && !idInput.value) idInput.value = userEmail.split('@')[0];
            }
        }, false);
        
        // Initial load
        document.addEventListener('DOMContentLoaded', () => {
            // Basic router, can be expanded
            if(adminToken) {
                showAddEditAccountPage(); // For testing, go directly here
            } else {
                showLoginPage();
            }
        });
    </script>
</body>
</html>